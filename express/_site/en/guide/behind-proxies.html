<!DOCTYPE html>
<!---
 Copyright (c) 2016 StrongLoop, IBM, and Express Contributors
 License: MIT
-->

<html lang="en" prefix="og: http://ogp.me/ns#">

  <head>
    <title>Express behind proxies</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="og:image" content="https://expressjs.com/images/express-facebook-share.png">
    <link rel="icon" type="image/png" href="/images/favicon.png" />
    <link rel="stylesheet" href="/css/style.css?_=1652552968">
    <link rel="stylesheet" href="/css/dropit.css">
    <link rel="stylesheet" href="/css/prism.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;amp;subset=latin,latin-ext">
    <link rel="stylesheet" href="/css/en.css">
    <link rel="stylesheet" href="/css/nodeinteractive.css">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script data-cfasync="false" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script data-cfasync="false" src="/js/ismobile.js"></script>
    <script data-cfasync="false" src="/js/app.js"></script>
    <script data-cfasync="false" src="/js/retina.js"></script>
    <script data-cfasync="false" src="/js/dropit.js"></script>
    <script data-cfasync="false" src="/js/prism.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />

</head>


  
  <body class="en-doc">
  

    <section class="page content">

      <header>
  <div id="blm-banner">
    Black Lives Matter. <br>
    <a id="blm-donate"  href="https://support.eji.org/give/153413/#!/donation/checkout">Support the Equal Justice Initiative</a>.
  </div>
  <div id="mobile-menu">
      <div id="nav-button" class="fa fa-bars fa-2x button"></div>
  </div>
  <section id="logo"><a href="/" class="express">Express</a>
  </section>
  <div id="navbar">
      <input id="q" placeholder="ðŸ”Ž search">
      <ul id="navmenu">
          <li><a href="/" id="home-menu">Home</a></li>
          <li>
              <ul id="getting-started-menu" class="menu">
                  <li><a href="/en/starter/installing.html">Getting started</a>
                      <ul>
                          <li>
                            <a href="/en/starter/installing.html">
                              Installing
                            </a>
                          </li>
                          <li>
                            <a href="/en/starter/hello-world.html">
                              Hello world
                            </a>
                          </li>
                          <li>
                          <a href="/en/starter/generator.html">
                            Express generator
                          </a>
                          </li>
                          <li>
                            <a href="/en/starter/basic-routing.html">
                              Basic routing
                            </a>
                          </li>
                          <li>
                            <a href="/en/starter/static-files.html">
                              Static files
                            </a>
                          </li>
                          <li>
                            <a href="/en/starter/examples.html">
                              More examples
                            </a>
                          </li>
                          <li>
                            <a href="/en/starter/faq.html">
                              FAQ
                            </a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
          <li>
              <ul id="guide-menu" class="menu">
                  <li><a href="/en/guide/routing.html" class="active">Guide</a>
                      <ul>
                          <li><a href="/en/guide/routing.html">Routing</a>
                          </li>
                          <li><a href="/en/guide/writing-middleware.html">Writing middleware</a>
                          </li>
                          <li><a href="/en/guide/using-middleware.html">Using middleware</a>
                          </li>
                          <li><a href="/en/guide/overriding-express-api.html">Overriding the Express API</a>
                          </li>
                          <li><a href="/en/guide/using-template-engines.html">Using template engines</a>
                          </li>
                          <li><a href="/en/guide/error-handling.html">Error handling</a>
                          </li>
                          <li><a href="/en/guide/debugging.html">Debugging</a>
                          </li>
                          <li><a href="/en/guide/behind-proxies.html">Express behind proxies</a>
                          </li>
                          <li><a href="/en/guide/migrating-4.html">Moving to Express 4</a>
                          </li>
                          <li><a href="/en/guide/migrating-5.html">Moving to Express 5</a>
                          </li>
                          <li><a href="/en/guide/database-integration.html">Database integration</a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
          <li>
              <ul id="application-menu" class="menu">
                  <li><a href="/en/4x/api.html">API reference</a>
                      <ul>
                          <li><a href="/en/5x/api.html">5.x (beta)</a>
                          </li>
                          <li><a href="/en/4x/api.html">4.x</a>
                          </li>
                          <li><a href="/en/3x/api.html">3.x (deprecated)</a>
                          </li>
                          <li><a href="/2x/">2.x (deprecated)</a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
          <li>
              <ul id="advanced-topics-menu" class="menu">
                  <li><a href="/en/advanced/developing-template-engines.html">Advanced topics</a>
                      <ul>
                          <li><a href="/en/advanced/developing-template-engines.html">Template engines</a>
                          </li>
                          <li><a href="/en/advanced/pm.html">Process managers</a>
                          </li>
                          <li><a href="/en/advanced/security-updates.html">Security updates</a>
                          </li>
                          <li><a href="/en/advanced/best-practice-security.html">Security best practices</a>
                          </li>
                          <li><a href="/en/advanced/best-practice-performance.html">Performance best practices</a>
                          </li>
                          <li><a href="/en/advanced/healthcheck-graceful-shutdown.html">Health checks and graceful shutdown</a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
          <li>
              <ul id="resources-menu" class="menu">
                  <li><a href="/en/resources/glossary.html">Resources</a>
                      <ul>
                          <li>
                            <a href="/en/resources/community.html">Community</a>
                          </li>
                          <li>
                            <a href="/en/resources/glossary.html">Glossary</a>
                          </li>
                          <li>
                            <a href="/en/resources/template-engines.html">Template Engines</a>
                          </li>
                          <li>
                            <a href="/en/resources/middleware.html">Middleware</a>
                          </li>
                          <li>
                            <a href="/en/resources/utils.html">Utility modules</a>
                          </li>
                          <li>
                            <a href="/en/resources/frameworks.html">Frameworks</a>
                          </li>
                          <li>
                            <a href="/en/resources/companies-using-express.html">Companies using Express</a>
                          </li>
                          <li>
                            <a href="/en/resources/open-source-using-express.html">Open-source projects</a>
                          </li>
                          <li>
                            <a href="/en/resources/learning.html">Additional learning</a>
                          </li>
                          <li>
                            <a href="/en/resources/contributing.html">Contributing to Express</a>
                          </li>
                          <li>
                            <a href="/en/changelog/4x.html">Release Change Log</a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
          <!--
          <li>
              <ul id="changelog-menu" class="menu">
                  <li><a href="/en/changelog/4x.html">Changelog</a>
                      <ul>
                          <li><a href="/en/changelog/4x.html">4.x</a></li>
                      </ul>
                  </li>
              </ul>
          </li>
        -->
      </ul>
  </div>
</header>


      <div id="overlay"></div>

      
      <div id="page-doc" markdown="1">
<h1 id="express-behind-proxies">Express behind proxies</h1>

<p>When running an Express app behind a reverse proxy, some of the Express APIs may return different values than expected. In order to adjust for this, the <code>trust proxy</code> application setting may be used to expose information provided by the reverse proxy in the Express APIs. The most common issue is express APIs that expose the clientâ€™s IP address may instead show an internal IP address of the reverse proxy.</p>

<div class="doc-box doc-info">
  <p>When configuring the <code>trust proxy</code> setting, it is important to understand the exact setup of the reverse proxy. Since this setting will trust values provided in the request, it is important that the combination of the setting in Express matches how the reverse proxy operates.</p>
</div>

<p>The application setting <code>trust proxy</code> may be set to one of the values listed in the following table.</p>

<table class="doctable" border="1">
  <thead><tr><th>Type</th><th>Value</th></tr></thead>
  <tbody>
    <tr>
      <td>Boolean</td>
<td>
        <p>If <code>true</code>, the clientâ€™s IP address is understood as the left-most entry in the <code>X-Forwarded-For</code> header.</p>

        <p>If <code>false</code>, the app is understood as directly facing the client and the clientâ€™s IP address is derived from <code>req.socket.remoteAddress</code>. This is the default setting.</p>

        <div class="doc-box doc-warn">
          <p>When setting to <code>true</code>, it is important to ensure that the last reverse proxy trusted is removing/overwriting all of the following HTTP headers: <code>X-Forwarded-For</code>, <code>X-Forwarded-Host</code>, and <code>X-Forwarded-Proto</code> otherwise it may be possible for the client to provide any value.</p>
        </div>
      </td>
    </tr>
    <tr>
      <td>IP addresses</td>
<td>
        <p>An IP address, subnet, or an array of IP addresses and subnets to trust as being a reverse proxy. The following list shows the pre-configured subnet names:</p>

        <ul>
          <li>loopback - <code>127.0.0.1/8</code>, <code>::1/128</code></li>
          <li>linklocal - <code>169.254.0.0/16</code>, <code>fe80::/10</code></li>
          <li>uniquelocal - <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code>, <code>fc00::/7</code></li>
        </ul>

        <p>You can set IP addresses in any of the following ways:</p>

        <pre><code class="language-js">app.set('trust proxy', 'loopback') // specify a single subnet
app.set('trust proxy', 'loopback, 123.123.123.123') // specify a subnet and an address
app.set('trust proxy', 'loopback, linklocal, uniquelocal') // specify multiple subnets as CSV
app.set('trust proxy', ['loopback', 'linklocal', 'uniquelocal']) // specify multiple subnets as an array
</code></pre>

        <p>When specified, the IP addresses or the subnets are excluded from the address determination process, and the untrusted IP address nearest to the application server is determined as the clientâ€™s IP address. This works by checking if <code>req.socket.remoteAddress</code> is trusted. If so, then each address in <code>X-Forwarded-For</code> is checked from right to left until the first non-trusted address.</p>
      </td>
    </tr>
    <tr>
      <td>Number</td>
<td>
        <p>Use the address that is at most <code>n</code> number of hops away from the Express application. <code>req.socket.remoteAddress</code> is the first hop, and the rest are looked for in the <code>X-Forwarded-For</code> header from right to left. A value of <code>0</code> means that the first untrusted address would be <code>req.socket.remoteAddress</code>, i.e. there is no reverse proxy.</p>

        <div class="doc-box doc-warn">
          <p>When using this setting, it is important to ensure there are not multiple, different-length paths to the Express application such that the client can be less than the configured number of hops away, otherwise it may be possible for the client to provide any value.</p>
        </div>
      </td>
    </tr>
    <tr>
      <td>Function</td>
<td>
        <p>Custom trust implementation.</p>

        <pre><code class="language-js">app.set('trust proxy', (ip) =&gt; {
  if (ip === '127.0.0.1' || ip === '123.123.123.123') return true // trusted IPs
  else return false
})
</code></pre>
      </td>
    </tr>
  </tbody>
</table>

<p>Enabling <code>trust proxy</code> will have the following impact:</p>

<ul>
  <li>
    <p>The value of <a href="/en/api.html#req.hostname">req.hostname</a> is derived from the value set in the <code>X-Forwarded-Host</code> header, which can be set by the client or by the proxy.</p>
  </li>
  <li>
    <p><code>X-Forwarded-Proto</code> can be set by the reverse proxy to tell the app whether it is <code>https</code> or  <code>http</code> or even an invalid name. This value is reflected by <a href="/en/api.html#req.protocol">req.protocol</a>.</p>
  </li>
  <li>
    <p>The <a href="/en/api.html#req.ip">req.ip</a> and <a href="/en/api.html#req.ips">req.ips</a> values are populated based on the socket address and <code>X-Forwarded-For</code> header, starting at the first untrusted address.</p>
  </li>
</ul>

<p>The <code>trust proxy</code> setting is implemented using the <a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a> package. For more information, see its documentation.</p>

      </div>
    </section>

    <a id="top" href="#"><img src="/images/arrow.png"></a>

<footer>
  <section id="doc-langs">
  Documentation translations provided by <a href="http://strongloop.com">StrongLoop/IBM</a>:
  <a href="/fr/">French</a>, <a href="/de/">German</a>, <a href="/es/">Spanish</a>, <a href="/it/">Italian</a>, <a href="/ja/">Japanese</a>, <a href="/ru/">Russian</a>, <a href="/zh-cn/">Chinese</a>, <a href="/zh-tw/">Traditional Chinese</a>, <a href="/ko/">Korean</a>, <a href="/pt-br/">Portuguese</a>.
  <br>
  Community translation available for: <a href="/sk/">Slovak</a>, <a href="/uk/">Ukrainian</a>, <a href="/uz/">Uzbek</a>, <a href="/tr/">Turkish</a> and <a href="/th/">Thai</a>.
  </section>
  <div id="footer-content">
      <div id="github">
        <a class="github-button" href="https://github.com/expressjs/expressjs.com" data-icon="octicon-star" aria-label="Star expressjs/expressjs.com on GitHub">Star</a>
      </div>
      <div id="sponsor"><a href="https://expressjs.com">Express</a> is a project of the <a href="https://openjsf.org">OpenJS Foundation</a>.</div>
      <div id="fork"><a href="https://github.com/expressjs/expressjs.com">Fork the website on GitHub</a>.</div>
      <div>Copyright &copy; 2017 StrongLoop, IBM, and other expressjs.com contributors.</div>
  </div>
  <div id="license">
      <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-ShareAlike 3.0 United States License</a>.
  </div>
</footer>

<script async defer src="https://buttons.github.io/buttons.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js" onload="docsearch({
  apiKey: '7164e33055faa6ecddefd9e08fc59f5d',
  indexName: 'expressjs',
  inputSelector: '#q',
  algoliaOptions: { 'facetFilters': ['lang:en'] }
})" async></script>



  </body>

</html>

